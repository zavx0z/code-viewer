<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>code-viewer</title>
    <!-- <script src="//cdn.jsdelivr.net/npm/eruda"></script>
    <script type="module" src="./dev/devTools.js"></script> -->
    <link rel="stylesheet" type="text/css" href="./dev/styles.css" />
    <script type="module" async defer>
      // const { proto } = await import("https://zavx0z.github.io/code-viewer/index.js")
      await import("./index.js")

      const actor = document.querySelector("code-viewer")
      document.querySelector("h1").textContent = actor.name

      let persistence = localStorage.getItem("code-viewer")
      if (persistence) actor.state = JSON.parse(persistence)

      actor.subscribe((snapshot) => {
        localStorage.setItem("code-viewer", JSON.stringify(snapshot))
      })

      if (Object.keys(actor.input).length) {
        const boolParams = Object.keys(actor.input).filter((key) => actor.input[key].type === "Boolean")

        const inputForm = document.createElement("form")
        inputForm.className = "input-form"
        inputForm.action = ""
        inputForm.method = "post"

        Object.entries(actor.input).forEach(([key, socket]) => {
          console.log(key, socket)
          console.log(socket.type)

          const div = document.createElement("div")
          const label = document.createElement("label")
          switch (socket.type) {
            case "Boolean":
              const checkbox = document.createElement("input")
              checkbox.type = "checkbox"
              checkbox.name = key
              checkbox.id = key
              checkbox.checked = socket.value
              checkbox.onchange = () => inputForm.requestSubmit()
              div.appendChild(checkbox)

              label.for = key
              label.textContent = socket.name.ru

              div.appendChild(label)
              inputForm.appendChild(div)
              break
            case "String":
              const textarea = document.createElement("textarea")
              textarea.name = key
              textarea.id = key
              textarea.value = socket.value
              textarea.cols = 80
              textarea.rows = 4
              textarea.onchange = () => inputForm.requestSubmit()
              div.appendChild(textarea)

              label.for = key
              div.appendChild(label)

              inputForm.appendChild(div)
              break
            default:
              break
          }
        })
        inputForm.addEventListener("submit", (e) => {
          e.preventDefault()
          const formData = new FormData(e.target)

          let obj = {}
          for (const [key, value] of formData) {
            obj[key] = value === "on" ? true : value
          }
          boolParams.forEach((key) => {
            if (!obj.hasOwnProperty(key)) obj[key] = false
          })
          actor.send(obj)
          return false
        })

        actor.parentElement.insertBefore(inputForm, actor)
      }
    </script>
  </head>

  <body>
    <h1></h1>
    <code-viewer />
  </body>
</html>
