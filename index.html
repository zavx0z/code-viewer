<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>code-viewer</title>
    <!-- <script src="//cdn.jsdelivr.net/npm/eruda"></script>
    <script type="module" src="./dev/devTools.js"></script> -->
    <link rel="stylesheet" type="text/css" href="./dev/styles.css" />
    <script type="module" async>
      const html = String.raw
      const url = "https://zavx0z.github.io/code-viewer/index.js"
      const tagname = url.match(/\.github\.io\/(.*?)\//)[1]
      await import("./index.js")

      const actor = document.createElement(tagname)
      let persistence = localStorage.getItem("code-viewer")
      persistence && (actor.state = JSON.parse(persistence))

      const template = document.createElement("template")
      template.innerHTML = html`
        <h1>${actor.name}</h1>
        <form>
          ${Object.entries(actor.input)
            .map(([key, socket]) => {
              switch (socket.type) {
                case "Boolean":
                  return html`
                    <div>
                      <input type="checkbox" id="${key}" name="${key}" ${socket.value ? "checked" : ""} />
                      <label for="${key}">${socket.name.ru}</label>
                    </div>
                  `
                case "String":
                  return html`
                    <div>
                      <label for="${key}">${socket.name.ru}</label>
                      <textarea cols="80" rows="4" id="${key}" name="${key}"> ${socket.value} </textarea>
                    </div>
                  `
                default:
                  return ""
              }
            })
            .join("")}
        </form>
      `
      actor.subscribe((snapshot) => localStorage.setItem("code-viewer", JSON.stringify(snapshot)))
      template.content.querySelector("form").addEventListener("change", (e) => {
        e.preventDefault()
        const formData = new FormData(e.currentTarget)
        const props = {}
        for (const key in actor.input) {
          const value = formData.get(key)
          if (actor.input[key].type === "Boolean") {
            props[key] = value === "on"
          } else props[key] = value
        }
        actor.send(props)
      })
      template.content.appendChild(actor)
      document.body.appendChild(template.content)
    </script>
  </head>
  <body></body>
</html>
